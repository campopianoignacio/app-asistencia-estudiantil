<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia Estudiantil</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .glass-header, .glass-nav { background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .dark .glass-header, .dark .glass-nav { background-color: rgba(17, 24, 39, 0.85); }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        .animate-subtle-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .nav-btn-active { color: #3b82f6; /* blue-500 */ }
        .dark .nav-btn-active { color: #60a5fa; /* blue-400 */ }
        /* Toggle Switch Styles */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <!-- Header section -->
    <header class="sticky top-0 z-50 flex items-center justify-between p-4 glass-header border-b border-gray-200 dark:border-gray-700">
        <h1 id="header-title" class="text-lg font-bold text-gray-800 dark:text-gray-200">Hoy</h1>
        <!-- Theme toggle button is now in settings -->
        <div class="w-8"></div> <!-- Placeholder to keep title centered -->
    </header>

    <!-- Main content area -->
    <main class="p-4 pb-24">
        <!-- Views -->
        <div id="view-hoy"></div>
        <div id="view-estudiantes" class="hidden"></div>
        <div id="view-agenda" class="hidden"></div>
        <div id="view-reportes" class="hidden"></div>
        <div id="view-configuracion" class="hidden"></div>
    </main>

    <!-- Bottom navigation bar -->
    <nav class="fixed bottom-0 left-0 right-0 glass-nav border-t border-gray-200 dark:border-gray-700 z-50">
         <div class="flex justify-around py-2">
            <button id="nav-hoy" class="nav-btn flex flex-col items-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2"/><line x1="16" y1="2" y2="6"/><line x1="8" y1="2" y2="6"/><line x1="3" y1="10" y2="21"/></svg>
                <span class="text-xs mt-1 font-medium">Hoy</span>
            </button>
            <button id="nav-estudiantes" class="nav-btn flex flex-col items-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="text-xs mt-1 font-medium">Estudiantes</span>
            </button>
            <button id="nav-agenda" class="nav-btn flex flex-col items-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2"/><line x1="16" y1="2" y2="6"/><line x1="8" y1="2" y2="6"/><line x1="3" y1="10" y2="10"/></svg>
                <span class="text-xs mt-1 font-medium">Agenda</span>
            </button>
            <button id="nav-reportes" class="nav-btn flex flex-col items-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 0-6-6h-1.7"/><path d="M13 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg>
                <span class="text-xs mt-1 font-medium">Reportes</span>
            </button>
            <button id="nav-configuracion" class="nav-btn flex flex-col items-center w-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.26.43a2 2 0 0 0 .01 2.73l.08.15a2 2 0 0 1 0 2v.44a2 2 0 0 1 0 2l-.08.15a2 2 0 0 0 .01 2.73l.26.43a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.26-.43a2 2 0 0 0 .01-2.73l-.08-.15a2 2 0 0 1 0-2v-.44a2 2 0 0 1 0-2l.08-.15a2 2 0 0 0-.01-2.73l-.26-.43a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                <span class="text-xs mt-1 font-medium">Ajustes</span>
            </button>
        </div>
    </nav>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA MANAGEMENT ---
        const DB_KEY = 'studentAttendanceApp';
        let appData = { students: [], attendance: {} };

        function loadData() {
            const data = localStorage.getItem(DB_KEY);
            if (data) { appData = JSON.parse(data); migrateOldData(); }
        }

        function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(appData)); }

        function migrateOldData() {
            let needsSave = false;
            for (const dateKey in appData.attendance) {
                for (const studentId in appData.attendance[dateKey]) {
                    const record = appData.attendance[dateKey][studentId];
                    if (typeof record === 'string') {
                        needsSave = true;
                        appData.attendance[dateKey][studentId] = { status: record, justified: false };
                    }
                }
            }
            if (needsSave) saveData();
        }

        // --- DOM ELEMENTS & STATE ---
        const views = { hoy: document.getElementById('view-hoy'), estudiantes: document.getElementById('view-estudiantes'), agenda: document.getElementById('view-agenda'), reportes: document.getElementById('view-reportes'), configuracion: document.getElementById('view-configuracion') };
        const navButtons = { hoy: document.getElementById('nav-hoy'), estudiantes: document.getElementById('nav-estudiantes'), agenda: document.getElementById('nav-agenda'), reportes: document.getElementById('nav-reportes'), configuracion: document.getElementById('nav-configuracion') };
        const headerTitle = document.getElementById('header-title');
        let currentView = 'hoy';
        let currentDate = new Date();
        let displayedDate = new Date();

        // --- UTILITY FUNCTIONS ---
        const getInitials = (name) => {
            if (!name) return '??';
            const words = name.trim().split(/\s+/);
            return words.length > 1 ? (words[0][0] + words[words.length - 1][0]).toUpperCase() : (words[0] ? words[0].substring(0, 2).toUpperCase() : '??');
        };
        const toISODateString = (date) => date.toISOString().split('T')[0];

        // --- VIEW ROUTING & RENDERING ---
        function switchView(viewName) {
            currentView = viewName;
            Object.keys(views).forEach(key => views[key].classList.toggle('hidden', key !== viewName));
            Object.keys(navButtons).forEach(key => {
                navButtons[key].classList.toggle('nav-btn-active', key === viewName);
                navButtons[key].classList.toggle('text-gray-400', key !== viewName);
            });
            
            const titles = { hoy: `Asistencia: ${displayedDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}`, estudiantes: 'Estudiantes', agenda: 'Agenda', reportes: 'Reporte de Ausencias', configuracion: 'Ajustes y Datos' };
            headerTitle.textContent = titles[viewName];
            
            const viewRenderers = { hoy: () => renderAttendanceList(toISODateString(displayedDate)), estudiantes: renderStudentManagementList, agenda: renderCalendar, reportes: renderReports, configuracion: renderConfigView };
            viewRenderers[viewName]();
        }

        // --- RENDER FUNCTIONS FOR EACH VIEW ---
        function renderAttendanceList(dateKey) {
            const container = views.hoy;
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <div id="status-counter" class="text-sm text-gray-500 dark:text-gray-400 font-medium"></div>
                    <button id="mark-all-btn" class="px-4 py-2 bg-blue-500 text-white text-sm font-semibold rounded-full shadow-lg hover:bg-blue-600 transition-colors w-44">Marcar Todos</button>
                </div>
                <div id="student-list-hoy" class="space-y-2"></div>`;

            const studentListEl = container.querySelector('#student-list-hoy');
            if (appData.students.length === 0) {
                studentListEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Agrega estudiantes en la secci√≥n 'Estudiantes'.</p>`;
                container.querySelector('#status-counter').textContent = '';
                container.querySelector('#mark-all-btn').classList.add('hidden');
                return;
            }

            appData.students.forEach(student => {
                const attendanceRecord = appData.attendance[dateKey] || {};
                const record = attendanceRecord[student.id] || { status: 'ausente', justified: false };
                studentListEl.innerHTML += createAttendanceCardHTML(student, record);
            });
            updateStatusAndCounter(dateKey);
            
            container.querySelector('#student-list-hoy').addEventListener('click', handleAttendanceClick);
            container.querySelector('#mark-all-btn').addEventListener('click', handleMarkAllClick);
        }

        function renderStudentManagementList() {
            views.estudiantes.innerHTML = `
                <form id="add-student-form" class="mb-6 flex gap-2">
                    <input type="text" id="student-name-input" placeholder="Nombre del nuevo estudiante" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200" required>
                    <button type="submit" class="px-4 py-2 bg-gray-800 text-white font-semibold rounded-lg hover:bg-gray-900 dark:bg-blue-600 dark:hover:bg-blue-700">Agregar</button>
                </form>
                <h2 class="text-lg font-semibold mb-2 text-gray-800 dark:text-gray-200">Lista de Estudiantes</h2>
                <div id="student-list-gestion" class="space-y-2"></div>`;
            
            const studentListGestionEl = views.estudiantes.querySelector('#student-list-gestion');
            studentListGestionEl.innerHTML = appData.students.length === 0 ? `<p class="text-center text-gray-500 dark:text-gray-400">No hay estudiantes registrados.</p>` : '';
            appData.students.forEach(student => {
                studentListGestionEl.innerHTML += `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center"><img src="${student.avatarUrl}" alt="${student.name}" class="w-10 h-10 rounded-full mr-3"/><span class="font-medium text-gray-800 dark:text-gray-200">${student.name}</span></div>
                        <button class="delete-student-btn text-red-500 hover:text-red-700 dark:hover:text-red-400" data-id="${student.id}">Eliminar</button>
                    </div>`;
            });
            views.estudiantes.querySelector('#add-student-form').addEventListener('submit', handleAddStudentSubmit);
            studentListGestionEl.addEventListener('click', handleDeleteStudentClick);
        }

        function renderCalendar() {
            views.agenda.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">&lt;</button>
                    <h2 id="month-year-header" class="text-lg font-semibold text-gray-800 dark:text-gray-200"></h2>
                    <button id="next-month-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">&gt;</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center"></div>`;

            const calendarGridEl = views.agenda.querySelector('#calendar-grid');
            const monthYearHeaderEl = views.agenda.querySelector('#month-year-header');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearHeaderEl.textContent = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'S√°'].forEach(day => { calendarGridEl.innerHTML += `<div class="font-bold text-gray-500 text-xs">${day}</div>`; });
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGridEl.innerHTML += '<div></div>'; }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const loopDate = new Date(year, month, day);
                const dayOfWeek = loopDate.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    calendarGridEl.innerHTML += `<div class="p-2 text-gray-400 dark:text-gray-600">${day}</div>`;
                } else {
                    const dateKey = toISODateString(loopDate);
                    const attendanceRecord = appData.attendance[dateKey];
                    let cellClass = "p-2 rounded-full cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-800";
                    if (attendanceRecord && Object.keys(attendanceRecord).length > 0) {
                        const presentCount = Object.values(attendanceRecord).filter(r => r.status === 'presente').length;
                        if (presentCount === appData.students.length && appData.students.length > 0) cellClass += " bg-green-200 dark:bg-green-800";
                        else cellClass += " bg-yellow-200 dark:bg-yellow-800";
                    }
                    calendarGridEl.innerHTML += `<div class="${cellClass}" data-date="${dateKey}">${day}</div>`;
                }
            }
            calendarGridEl.addEventListener('click', handleCalendarClick);
            views.agenda.querySelector('#prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            views.agenda.querySelector('#next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        }

        function renderReports() {
            const container = views.reportes;
            if (appData.students.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No hay estudiantes para mostrar reportes.</p>`;
                return;
            }
            const reports = appData.students.map(student => {
                const report = { studentName: student.name, avatarUrl: student.avatarUrl, total: 0, justified: 0, unjustified: 0 };
                for (const dateKey in appData.attendance) {
                    const record = appData.attendance[dateKey][student.id];
                    if (record && record.status === 'ausente') {
                        report.total++;
                        if (record.justified) report.justified++;
                        else report.unjustified++;
                    }
                }
                return report;
            });
            let content = '<div class="space-y-3">';
            reports.forEach(report => {
                content += `
                <div class="p-4 rounded-xl border bg-white dark:bg-gray-800 dark:border-gray-700 shadow-sm">
                    <div class="flex items-center mb-3"><img src="${report.avatarUrl}" alt="${report.studentName}" class="w-11 h-11 rounded-full mr-4"/><span class="font-bold text-lg text-gray-800 dark:text-gray-200">${report.studentName}</span></div>
                    <div class="grid grid-cols-3 text-center">
                        <div><p class="text-2xl font-semibold text-red-500">${report.unjustified}</p><p class="text-xs text-gray-500 dark:text-gray-400">Sin Justificar</p></div>
                        <div><p class="text-2xl font-semibold text-yellow-500">${report.justified}</p><p class="text-xs text-gray-500 dark:text-gray-400">Justificadas</p></div>
                        <div><p class="text-2xl font-bold text-gray-700 dark:text-gray-300">${report.total}</p><p class="text-xs text-gray-500 dark:text-gray-400">Total Faltas</p></div>
                    </div>
                </div>`;
            });
            container.innerHTML = content + '</div>';
        }

        function renderConfigView() {
            const isDark = document.documentElement.classList.contains('dark');
            views.configuracion.innerHTML = `
                <div class="space-y-8">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Apariencia</h2>
                        <div class="flex items-center justify-between bg-white dark:bg-gray-800 p-4 rounded-lg border dark:border-gray-700">
                            <label for="theme-toggle-checkbox" class="font-medium text-gray-700 dark:text-gray-300">Modo Oscuro</label>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" id="theme-toggle-checkbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${isDark ? 'checked' : ''}/>
                                <label for="theme-toggle-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Gesti√≥n de Datos</h2>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border dark:border-gray-700 space-y-4">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Guarda una copia de seguridad de todos tus datos.</p>
                                <button id="export-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">Exportar a JSON</button>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Carga datos desde un archivo. <strong class=\"text-red-500\">Se reemplazar√°n los datos actuales.</strong></p>
                                <input type="file" id="import-file-input" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            </div>
                        </div>
                    </div>
                </div>`;
            views.configuracion.querySelector('#theme-toggle-checkbox').addEventListener('change', toggleTheme);
            views.configuracion.querySelector('#export-btn').addEventListener('click', exportData);
            views.configuracion.querySelector('#import-file-input').addEventListener('change', importData);
        }

        // --- EVENT HANDLERS ---
        function handleAttendanceClick(e) {
            const cardEl = e.target.closest('[data-id]');
            if (!cardEl) return;
            const studentId = cardEl.dataset.id;
            const dateKey = toISODateString(displayedDate);
            if (!appData.attendance[dateKey]) appData.attendance[dateKey] = {};
            if (!appData.attendance[dateKey][studentId]) appData.attendance[dateKey][studentId] = { status: 'ausente', justified: false };

            if (e.target.classList.contains('justify-btn')) {
                appData.attendance[dateKey][studentId].justified = true;
            } else {
                const currentStatus = appData.attendance[dateKey][studentId].status;
                appData.attendance[dateKey][studentId].status = currentStatus === 'presente' ? 'ausente' : 'presente';
            }
            saveData();
            renderAttendanceList(dateKey);
        }

        function handleMarkAllClick() {
            const dateKey = toISODateString(displayedDate);
            if (!appData.attendance[dateKey]) appData.attendance[dateKey] = {};
            const allPresent = appData.students.every(s => appData.attendance[dateKey][s.id] && appData.attendance[dateKey][s.id].status === 'presente');
            const newStatus = allPresent ? 'ausente' : 'presente';
            appData.students.forEach(s => { appData.attendance[dateKey][s.id] = { status: newStatus, justified: false }; });
            saveData();
            renderAttendanceList(dateKey);
        }

        function handleAddStudentSubmit(e) {
            e.preventDefault();
            const studentNameInput = views.estudiantes.querySelector('#student-name-input');
            const studentName = studentNameInput.value.trim();
            if (studentName) {
                const newStudent = { id: `s_${Date.now()}`, name: studentName, avatarUrl: `https://placehold.co/100x100/d1d5db/ffffff?text=${getInitials(studentName)}` };
                appData.students.push(newStudent);
                saveData();
                renderStudentManagementList();
                studentNameInput.value = '';
            }
        }

        function handleDeleteStudentClick(e) {
            if (e.target.classList.contains('delete-student-btn')) {
                const studentId = e.target.dataset.id;
                if (confirm('¬øSeguro que quieres eliminar este estudiante? Esto borrar√° tambi√©n todo su historial de asistencia.')) {
                    appData.students = appData.students.filter(s => s.id !== studentId);
                    Object.keys(appData.attendance).forEach(dateKey => { delete appData.attendance[dateKey][studentId]; });
                    saveData();
                    renderStudentManagementList();
                }
            }
        }

        function handleCalendarClick(e) {
            if (e.target.dataset.date) {
                const [year, month, day] = e.target.dataset.date.split('-').map(Number);
                displayedDate = new Date(year, month - 1, day);
                switchView('hoy');
            }
        }

        // --- IMPORT/EXPORT & THEME LOGIC ---
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `asistencia-backup-${toISODateString(new Date())}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.students || !importedData.attendance) throw new Error('El archivo no tiene el formato correcto.');
                    if (confirm('¬øEst√°s seguro de que quieres importar estos datos? Todos los datos actuales ser√°n reemplazados.')) {
                        appData = importedData;
                        saveData();
                        migrateOldData();
                        alert('¬°Datos importados con √©xito!');
                        switchView('hoy');
                    }
                } catch (error) { alert(`Error al importar el archivo: ${error.message}`); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        const THEME_KEY = 'theme';
        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            const themeToggle = document.getElementById('theme-toggle-checkbox');
            if (themeToggle) themeToggle.checked = theme === 'dark';
        }

        function toggleTheme() {
            const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme);
        }

        function loadInitialTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));
        }

        // --- CARD & COUNTER HTML ---
        function createAttendanceCardHTML(student, record) {
            const isPresent = record.status === 'presente';
            const isJustified = record.justified;
            let statusText = isPresent ? 'Presente' : 'Ausente';
            if (!isPresent && isJustified) statusText += ' (J)';
            const cardClasses = isPresent ? 'bg-green-50 border-green-200 dark:bg-green-900/50 dark:border-green-800' : (isJustified ? 'bg-yellow-50 border-yellow-200 dark:bg-yellow-900/50 dark:border-yellow-800' : 'bg-red-50 border-red-200 dark:bg-red-900/50 dark:border-red-800');
            const statusBadgeColor = isPresent ? 'bg-green-500 animate-subtle-pulse' : (isJustified ? 'bg-yellow-500' : 'bg-red-500');
            const justifyButton = !isPresent && !isJustified ? `<button class="justify-btn text-xs py-1 px-2 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Justificar</button>` : '';
            return `
                <div class="flex items-center justify-between p-4 rounded-xl border shadow-sm cursor-pointer ${cardClasses}" data-id="${student.id}">
                    <div class="flex items-center pointer-events-none"><img src="${student.avatarUrl}" alt="${student.name}" class="w-12 h-12 rounded-full mr-4"/><span class="font-semibold text-gray-800 dark:text-gray-200">${student.name}</span></div>
                    <div class="flex items-center space-x-3"><span class="text-xs font-bold px-2 py-1 rounded-full text-white ${statusBadgeColor}">${statusText}</span>${justifyButton}</div>
                </div>`;
        }

        function updateStatusAndCounter(dateKey) {
            const container = views.hoy;
            const statusCounterEl = container.querySelector('#status-counter');
            const attendanceRecord = appData.attendance[dateKey] || {};
            const presentCount = appData.students.filter(s => (attendanceRecord[s.id] ? attendanceRecord[s.id].status : 'ausente') === 'presente').length;
            statusCounterEl.textContent = `${presentCount} / ${appData.students.length} Presentes`;
            const allPresent = presentCount === appData.students.length;
            container.querySelector('#mark-all-btn').textContent = allPresent ? 'Marcar Ausentes' : 'Marcar Presentes';
        }

        // --- INITIALIZATION ---
        navButtons.hoy.addEventListener('click', () => { displayedDate = new Date(); switchView('hoy'); });
        navButtons.estudiantes.addEventListener('click', () => switchView('estudiantes'));
        navButtons.agenda.addEventListener('click', () => switchView('agenda'));
        navButtons.reportes.addEventListener('click', () => switchView('reportes'));
        navButtons.configuracion.addEventListener('click', () => switchView('configuracion'));

        loadInitialTheme();
        loadData();
        switchView('hoy');
    });
    </script>

</body>
</html>