<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia Estudiantil</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .glass-header, .glass-nav { background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .dark .glass-header, .dark .glass-nav { background-color: rgba(17, 24, 39, 0.85); }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        .animate-subtle-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .nav-btn-active { color: #3b82f6; }
        .dark .nav-btn-active { color: #60a5fa; }
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <!-- Container for Authentication (Login/Register) -->
    <div id="auth-container">
        <div class="flex flex-col items-center justify-center min-h-screen p-4">
            <div id="login-view" class="w-full max-w-sm">
                <h1 class="text-3xl font-bold text-center text-gray-800 dark:text-gray-200 mb-6">Iniciar Sesión</h1>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200" required>
                    <input type="password" id="login-password" placeholder="Contraseña" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200" required>
                    <button type="submit" class="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Entrar</button>
                </form>
                <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
                <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-4">¿No tienes cuenta? <a href="#" id="show-register" class="font-medium text-blue-600 hover:underline">Regístrate</a></p>
            </div>
            <div id="register-view" class="w-full max-w-sm hidden">
                <h1 class="text-3xl font-bold text-center text-gray-800 dark:text-gray-200 mb-6">Crear Cuenta</h1>
                <form id="register-form" class="space-y-4">
                    <input type="email" id="register-email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200" required>
                    <input type="password" id="register-password" placeholder="Contraseña" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200" required>
                    <button type="submit" class="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Registrar</button>
                </form>
                <p id="register-error" class="text-red-500 text-sm text-center mt-4"></p>
                <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-4">¿Ya tienes cuenta? <a href="#" id="show-login" class="font-medium text-blue-600 hover:underline">Inicia Sesión</a></p>
            </div>
        </div>
    </div>

    <!-- Container for the main application (hidden by default) -->
    <div id="app-container" class="hidden">
        <header class="sticky top-0 z-50 flex items-center justify-between p-4 glass-header border-b border-gray-200 dark:border-gray-700">
            <h1 id="header-title" class="text-lg font-bold text-gray-800 dark:text-gray-200"></h1>
            <button id="logout-btn" class="text-sm font-medium text-red-500 hover:text-red-700 dark:hover:text-red-400">Salir</button>
        </header>
        <main class="p-4 pb-24">
            <div id="view-hoy"></div>
            <div id="view-estudiantes" class="hidden"></div>
            <div id="view-agenda" class="hidden"></div>
            <div id="view-reportes" class="hidden"></div>
            <div id="view-configuracion" class="hidden"></div>
        </main>
        <nav class="fixed bottom-0 left-0 right-0 glass-nav border-t border-gray-200 dark:border-gray-700 z-50">
            <div class="flex justify-around py-2">
                <button id="nav-hoy" class="nav-btn flex flex-col items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2"/><line x1="16" y1="2" y2="6"/><line x1="8" y1="2" y2="6"/><line x1="3" y1="10" y2="21"/></svg><span class="text-xs mt-1 font-medium">Hoy</span></button>
                <button id="nav-estudiantes" class="nav-btn flex flex-col items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><span class="text-xs mt-1 font-medium">Estudiantes</span></button>
                <button id="nav-agenda" class="nav-btn flex flex-col items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2"/><line x1="16" y1="2" y2="6"/><line x1="8" y1="2" y2="6"/><line x1="3" y1="10" y2="10"/></svg><span class="text-xs mt-1 font-medium">Agenda</span></button>
                <button id="nav-reportes" class="nav-btn flex flex-col items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 0-6-6h-1.7"/><path d="M13 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg><span class="text-xs mt-1 font-medium">Reportes</span></button>
                <button id="nav-configuracion" class="nav-btn flex flex-col items-center w-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.26.43a2 2 0 0 0 .01 2.73l.08.15a2 2 0 0 1 0 2v.44a2 2 0 0 1 0 2l-.08.15a2 2 0 0 0 .01 2.73l.26.43a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.26-.43a2 2 0 0 0 .01-2.73l-.08-.15a2 2 0 0 1 0-2v-.44a2 2 0 0 1 0-2l.08-.15a2 2 0 0 0-.01-2.73l-.26-.43a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg><span class="text-xs mt-1 font-medium">Ajustes</span></button>
            </div>
        </nav>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const API_URL = 'http://localhost:3000';
        const TOKEN_KEY = 'attendanceAppToken';

        // --- DOM ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');

        // --- APP STATE ---
        let appData = { students: [], attendance: {} };
        let currentView = 'hoy';
        let currentDate = new Date();
        let displayedDate = new Date();

        // ===================================================================================
        // AUTHENTICATION & DATA SYNC LOGIC
        // ===================================================================================
        function getAuthToken() { return localStorage.getItem(TOKEN_KEY); }
        function setAuthToken(token) { localStorage.setItem(TOKEN_KEY, token); }
        function removeAuthToken() { localStorage.removeItem(TOKEN_KEY); }

        async function loadData() {
            const token = getAuthToken();
            if (!token) return handleLogout();

            try {
                const response = await fetch(`${API_URL}/api/data`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Token inválido o expirado.');
                }
                if (!response.ok) {
                    throw new Error('Error al cargar los datos del servidor.');
                }
                appData = await response.json();
                if (!appData.students) appData.students = [];
                if (!appData.attendance) appData.attendance = {};
            } catch (error) {
                console.error(error.message);
                handleLogout(); // Si hay error con el token o datos, cerramos sesión
            }
        }

        async function saveData() {
            const token = getAuthToken();
            if (!token) return handleLogout();

            try {
                await fetch(`${API_URL}/api/data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(appData)
                });
            } catch (error) {
                console.error('No se pudieron guardar los datos:', error);
                alert('Error: No se pudieron guardar los cambios en el servidor.');
            }
        }

        function initAuth() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); toggleAuthView(false); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); toggleAuthView(true); });
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            if (getAuthToken()) {
                showApp();
            } else {
                showAuth();
            }
        }

        function toggleAuthView(showLogin) {
            loginView.classList.toggle('hidden', !showLogin);
            registerView.classList.toggle('hidden', showLogin);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';

            try {
                const response = await fetch(`${API_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                const data = await response.json(); // Intenta procesar la respuesta como JSON

                if (!response.ok) {
                    // Si la respuesta no es exitosa (ej. 401, 400), usa el mensaje del JSON
                    throw new Error(data.message || 'Error al iniciar sesión.');
                }
                
                // Si todo fue bien, guarda el token y muestra la app
                setAuthToken(data.accessToken);
                showApp();
            } catch (err) {
                // Este bloque se activa si fetch falla, si response.json() falla, o si lanzamos el error manualmente
                if (err instanceof SyntaxError) {
                    // Esto ocurre si el servidor envía algo que no es JSON
                    errorEl.textContent = "Error: Respuesta inválida del servidor.";
                } else {
                    errorEl.textContent = err.message;
                }
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');
            errorEl.textContent = '';

            try {
                const response = await fetch(`${API_URL}/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                const data = await response.json(); // Siempre esperamos una respuesta JSON

                if (!response.ok) {
                    // Si hay un error, usamos el mensaje del servidor
                    throw new Error(data.message || 'Error al registrar la cuenta.');
                }

                alert(data.message || '¡Registro exitoso! Por favor, inicia sesión.');
                toggleAuthView(true);
            } catch (err) {
                if (err instanceof SyntaxError) {
                    errorEl.textContent = "Error: Respuesta inválida del servidor.";
                } else {
                    errorEl.textContent = err.message;
                }
            }
        }

        function handleLogout() {
            removeAuthToken();
            appData = { students: [], attendance: {} }; // Limpiar datos en memoria
            showAuth();
        }

        function showAuth() {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        async function showApp() {
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            await loadData(); // Cargar datos del servidor antes de inicializar la app
            initializeApp();
        }

        // ===================================================================================
        // MAIN APPLICATION LOGIC
        // ===================================================================================
        function initializeApp() {
            const navButtons = { hoy: document.getElementById('nav-hoy'), estudiantes: document.getElementById('nav-estudiantes'), agenda: document.getElementById('nav-agenda'), reportes: document.getElementById('nav-reportes'), configuracion: document.getElementById('nav-configuracion') };
            navButtons.hoy.addEventListener('click', () => { displayedDate = new Date(); switchView('hoy'); });
            navButtons.estudiantes.addEventListener('click', () => switchView('estudiantes'));
            navButtons.agenda.addEventListener('click', () => switchView('agenda'));
            navButtons.reportes.addEventListener('click', () => switchView('reportes'));
            navButtons.configuracion.addEventListener('click', () => switchView('configuracion'));
            
            loadInitialTheme();
            switchView('hoy');
        }

        function switchView(viewName) {
            currentView = viewName;
            const views = { hoy: document.getElementById('view-hoy'), estudiantes: document.getElementById('view-estudiantes'), agenda: document.getElementById('view-agenda'), reportes: document.getElementById('view-reportes'), configuracion: document.getElementById('view-configuracion') };
            Object.keys(views).forEach(key => views[key].classList.toggle('hidden', key !== viewName));
            
            const titles = { hoy: `Asistencia: ${displayedDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}`, estudiantes: 'Estudiantes', agenda: 'Agenda', reportes: 'Reporte de Ausencias', configuracion: 'Ajustes' };
            document.getElementById('header-title').textContent = titles[viewName];
            
            const viewRenderers = { hoy: () => renderAttendanceList(toISODateString(displayedDate)), estudiantes: renderStudentManagementList, agenda: renderCalendar, reportes: renderReports, configuracion: renderConfigView };
            viewRenderers[viewName]();
        }

        // --- THEME MANAGEMENT ---
        const THEME_KEY = 'theme';
        function applyTheme(theme) { document.documentElement.classList.toggle('dark', theme === 'dark'); const themeToggle = document.getElementById('theme-toggle-checkbox'); if (themeToggle) themeToggle.checked = theme === 'dark'; }
        function toggleTheme() { const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark'; localStorage.setItem(THEME_KEY, newTheme); applyTheme(newTheme); }
        function loadInitialTheme() { const savedTheme = localStorage.getItem(THEME_KEY); const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light')); }

        // --- RENDER FUNCTIONS ---
        function renderAttendanceList(dateKey) {
            const container = document.getElementById('view-hoy');
            container.innerHTML = `<div class="flex justify-between items-center mb-4"><div id="status-counter" class="text-sm text-gray-500 dark:text-gray-400 font-medium"></div><button id="mark-all-btn" class="px-4 py-2 bg-blue-500 text-white text-sm font-semibold rounded-full shadow-lg hover:bg-blue-600 w-44">Marcar Todos</button></div><div id="student-list-hoy" class="space-y-2"></div>`;
            const studentListEl = container.querySelector('#student-list-hoy');
            if (!appData.students || appData.students.length === 0) {
                studentListEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Agrega estudiantes en la sección 'Estudiantes'.</p>`;
                container.querySelector('#status-counter').textContent = '';
                container.querySelector('#mark-all-btn').classList.add('hidden');
                return;
            }
            const attendanceRecord = appData.attendance[dateKey] || {};
            appData.students.forEach(student => { const record = attendanceRecord[student.id] || { status: 'ausente', justified: false }; studentListEl.innerHTML += createAttendanceCardHTML(student, record); });
            updateStatusAndCounter(dateKey);
            container.querySelector('#student-list-hoy').addEventListener('click', handleAttendanceClick);
            container.querySelector('#mark-all-btn').addEventListener('click', handleMarkAllClick);
        }

        function renderStudentManagementList() {
            const container = document.getElementById('view-estudiantes');
            container.innerHTML = `<form id="add-student-form" class="mb-6 flex gap-2"><input type="text" id="student-name-input" placeholder="Nombre" class="flex-grow p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-600" required><button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg">Agregar</button></form><h2 class="text-lg font-semibold mb-2 dark:text-gray-200">Lista</h2><div id="student-list-gestion" class="space-y-2"></div>`;
            const studentListGestionEl = container.querySelector('#student-list-gestion');
            studentListGestionEl.innerHTML = !appData.students || appData.students.length === 0 ? `<p class="text-center text-gray-500 dark:text-gray-400">No hay estudiantes.</p>` : '';
            if(appData.students) appData.students.forEach(student => { studentListGestionEl.innerHTML += `<div class="flex items-center justify-between p-3 rounded-lg bg-white dark:bg-gray-800 border dark:border-gray-700"><div class="flex items-center"><img src="${student.avatarUrl}" alt="${student.name}" class="w-10 h-10 rounded-full mr-3"/><span class="font-medium dark:text-gray-200">${student.name}</span></div><button class="delete-student-btn text-red-500 hover:text-red-700" data-id="${student.id}">Eliminar</button></div>`; });
            container.querySelector('#add-student-form').addEventListener('submit', handleAddStudentSubmit);
            studentListGestionEl.addEventListener('click', handleDeleteStudentClick);
        }

        function renderCalendar() {
            const container = document.getElementById('view-agenda');
            container.innerHTML = `<div class="flex items-center justify-between mb-4"><button id="prev-month-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">&lt;</button><h2 id="month-year-header" class="text-lg font-semibold dark:text-gray-200"></h2><button id="next-month-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">&gt;</button></div><div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center"></div>`;
            const calendarGridEl = container.querySelector('#calendar-grid');
            const monthYearHeaderEl = container.querySelector('#month-year-header');
            const year = currentDate.getFullYear(); const month = currentDate.getMonth();
            monthYearHeaderEl.textContent = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sá'].forEach(day => { calendarGridEl.innerHTML += `<div class="font-bold text-gray-500 text-xs">${day}</div>`; });
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGridEl.innerHTML += '<div></div>'; }
            for (let day = 1; day <= daysInMonth; day++) {
                const loopDate = new Date(year, month, day); const dayOfWeek = loopDate.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) { calendarGridEl.innerHTML += `<div class="p-2 text-gray-400 dark:text-gray-600">${day}</div>`;
                } else {
                    const dateKey = toISODateString(loopDate); const attendanceRecord = appData.attendance ? appData.attendance[dateKey] : undefined;
                    let cellClass = "p-2 rounded-full cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-800";
                    if (attendanceRecord && Object.keys(attendanceRecord).length > 0) { const presentCount = Object.values(attendanceRecord).filter(r => r.status === 'presente').length; if (appData.students && presentCount === appData.students.length && appData.students.length > 0) cellClass += " bg-green-200 dark:bg-green-800"; else cellClass += " bg-yellow-200 dark:bg-yellow-800"; }
                    calendarGridEl.innerHTML += `<div class="${cellClass}" data-date="${dateKey}">${day}</div>`;
                }
            }
            calendarGridEl.addEventListener('click', handleCalendarClick);
            container.querySelector('#prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            container.querySelector('#next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        }

        function renderReports() {
            const container = document.getElementById('view-reportes');
            if (!appData.students || appData.students.length === 0) { container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No hay estudiantes.</p>`; return; }
            const reports = appData.students.map(student => {
                const report = { studentName: student.name, avatarUrl: student.avatarUrl, total: 0, justified: 0, unjustified: 0 };
                if(appData.attendance) for (const dateKey in appData.attendance) { const record = appData.attendance[dateKey][student.id]; if (record && record.status === 'ausente') { report.total++; if (record.justified) report.justified++; else report.unjustified++; } }
                return report;
            });
            let content = '<div class="space-y-3">';
            reports.forEach(report => { content += `<div class="p-4 rounded-xl border bg-white dark:bg-gray-800 dark:border-gray-700"><div class="flex items-center mb-3"><img src="${report.avatarUrl}" alt="${report.studentName}" class="w-11 h-11 rounded-full mr-4"/><span class="font-bold text-lg dark:text-gray-200">${report.studentName}</span></div><div class="grid grid-cols-3 text-center"><div><p class="text-2xl font-semibold text-red-500">${report.unjustified}</p><p class="text-xs text-gray-500">Sin Justificar</p></div><div><p class="text-2xl font-semibold text-yellow-500">${report.justified}</p><p class="text-xs text-gray-500">Justificadas</p></div><div><p class="text-2xl font-bold text-gray-700 dark:text-gray-300">${report.total}</p><p class="text-xs text-gray-500">Total Faltas</p></div></div></div>`; });
            container.innerHTML = content + '</div>';
        }

        function renderConfigView() {
            const container = document.getElementById('view-configuracion');
            const isDark = document.documentElement.classList.contains('dark');
            container.innerHTML = `<div class="space-y-8"><div><h2 class="text-lg font-semibold dark:text-gray-200 mb-2">Apariencia</h2><div class="flex items-center justify-between bg-white dark:bg-gray-800 p-4 rounded-lg border dark:border-gray-700"><label for="theme-toggle-checkbox" class="font-medium dark:text-gray-300">Modo Oscuro</label><div class="relative inline-block w-10 mr-2 align-middle"><input type="checkbox" id="theme-toggle-checkbox" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${isDark ? 'checked' : ''}/><label for="theme-toggle-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div></div></div>`;
            container.querySelector('#theme-toggle-checkbox').addEventListener('change', toggleTheme);
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        const getInitials = (name) => { if (!name) return '??'; const words = name.trim().split(/\s+/); return words.length > 1 ? (words[0][0] + words[words.length - 1][0]).toUpperCase() : (words[0] ? words[0].substring(0, 2).toUpperCase() : '??'); };
        const toISODateString = (date) => date.toISOString().split('T')[0];
        function createAttendanceCardHTML(student, record) { const isPresent = record.status === 'presente'; const isJustified = record.justified; let statusText = isPresent ? 'Presente' : 'Ausente'; if (!isPresent && isJustified) statusText += ' (J)'; const cardClasses = isPresent ? 'bg-green-50 dark:bg-green-900/50' : (isJustified ? 'bg-yellow-50 dark:bg-yellow-900/50' : 'bg-red-50 dark:bg-red-900/50'); const statusBadgeColor = isPresent ? 'bg-green-500' : (isJustified ? 'bg-yellow-500' : 'bg-red-500'); const justifyButton = !isPresent && !isJustified ? `<button class="justify-btn text-xs py-1 px-2 rounded-md bg-gray-200 dark:bg-gray-600">Justificar</button>` : ''; return `<div class="flex items-center justify-between p-4 rounded-xl border dark:border-gray-700 shadow-sm cursor-pointer ${cardClasses}" data-id="${student.id}"><div class="flex items-center pointer-events-none"><img src="${student.avatarUrl}" alt="${student.name}" class="w-12 h-12 rounded-full mr-4"/><span class="font-semibold dark:text-gray-200">${student.name}</span></div><div class="flex items-center space-x-3"><span class="text-xs font-bold px-2 py-1 rounded-full text-white ${statusBadgeColor}">${statusText}</span>${justifyButton}</div></div>`; }
        function updateStatusAndCounter(dateKey) { const container = document.getElementById('view-hoy'); const statusCounterEl = container.querySelector('#status-counter'); const attendanceRecord = appData.attendance ? appData.attendance[dateKey] || {} : {}; const presentCount = appData.students ? appData.students.filter(s => (attendanceRecord[s.id] ? attendanceRecord[s.id].status : 'ausente') === 'presente').length : 0; const totalStudents = appData.students ? appData.students.length : 0; statusCounterEl.textContent = `${presentCount} / ${totalStudents} Presentes`; container.querySelector('#mark-all-btn').textContent = presentCount === totalStudents ? 'Marcar Ausentes' : 'Marcar Presentes'; }

        // --- EVENT HANDLERS for main app ---
        async function handleAttendanceClick(e) { const cardEl = e.target.closest('[data-id]'); if (!cardEl) return; const studentId = cardEl.dataset.id; const dateKey = toISODateString(displayedDate); if (!appData.attendance[dateKey]) appData.attendance[dateKey] = {}; if (!appData.attendance[dateKey][studentId]) appData.attendance[dateKey][studentId] = { status: 'ausente', justified: false }; if (e.target.classList.contains('justify-btn')) { appData.attendance[dateKey][studentId].justified = true; } else { const currentStatus = appData.attendance[dateKey][studentId].status; appData.attendance[dateKey][studentId].status = currentStatus === 'presente' ? 'ausente' : 'presente'; } await saveData(); renderAttendanceList(dateKey); }
        async function handleMarkAllClick() { const dateKey = toISODateString(displayedDate); if (!appData.attendance[dateKey]) appData.attendance[dateKey] = {}; const allPresent = appData.students && appData.students.every(s => appData.attendance[dateKey][s.id] && appData.attendance[dateKey][s.id].status === 'presente'); const newStatus = allPresent ? 'ausente' : 'presente'; if(appData.students) appData.students.forEach(s => { appData.attendance[dateKey][s.id] = { status: newStatus, justified: false }; }); await saveData(); renderAttendanceList(dateKey); }
        async function handleAddStudentSubmit(e) { e.preventDefault(); const studentNameInput = document.getElementById('view-estudiantes').querySelector('#student-name-input'); const studentName = studentNameInput.value.trim(); if (studentName) { const newStudent = { id: `s_${Date.now()}`, name: studentName, avatarUrl: `https://placehold.co/100x100/d1d5db/ffffff?text=${getInitials(studentName)}` }; if(!appData.students) appData.students = []; appData.students.push(newStudent); await saveData(); renderStudentManagementList(); studentNameInput.value = ''; } }
        async function handleDeleteStudentClick(e) { if (e.target.classList.contains('delete-student-btn')) { const studentId = e.target.dataset.id; if (confirm('¿Seguro que quieres eliminar este estudiante?')) { if(appData.students) appData.students = appData.students.filter(s => s.id !== studentId); if(appData.attendance) Object.keys(appData.attendance).forEach(dateKey => { delete appData.attendance[dateKey][studentId]; }); await saveData(); renderStudentManagementList(); } } }
        function handleCalendarClick(e) { if (e.target.dataset.date) { const [year, month, day] = e.target.dataset.date.split('-').map(Number); displayedDate = new Date(year, month - 1, day); switchView('hoy'); } }

        // --- INITIALIZE APP ---
        initAuth();
    });
    </script>
</body>
</html>